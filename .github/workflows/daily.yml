name: Daily Papers

on:
  schedule:
    - cron: "*/30 0-6 * * *"  # 每 30 分鐘輪詢，UTC 00:00–06:30（UTC+8 08:00–14:30）
  workflow_dispatch:       # allow manual trigger from GitHub UI
    inputs:
      date:
        description: "Target date (YYYY-MM-DD), leave blank for today"
        required: false

permissions:
  contents: write   # needed to push data/ and docs/ back to repo

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync

      - name: Run pipeline
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DOTSOCR_ENDPOINT: ${{ secrets.DOTSOCR_ENDPOINT }}
          DOTSOCR_API_KEY: ${{ secrets.DOTSOCR_API_KEY }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          SITE_BASE_URL: https://lianghsun.github.io/hf-papers-zh-tw
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            uv run python -m src.main "${{ github.event.inputs.date }}"
          else
            uv run python -m src.main
          fi

      - name: Build pagefind search index
        run: npx --yes pagefind --source docs
        continue-on-error: true   # pagefind fails gracefully if docs/ is empty

      - name: Commit and push results
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ docs/
          git diff --staged --quiet || git commit -m "Daily update $(date -u +%Y-%m-%d)"
          git push
